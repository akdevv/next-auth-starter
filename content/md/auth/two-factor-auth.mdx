---
title: 'Adding 2FA'
description: 'Learn how to implement and configure two-factor authentication in your Next.js application'
---

# Adding Two-Factor Authentication

## Overview

Two-factor authentication (2FA) adds an extra layer of security to your application. This guide covers implementation using authenticator apps and backup codes.

## Implementation

### 1. Database Schema

```prisma
// prisma/schema.prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  twoFactorSecret String?
  twoFactorEnabled Boolean @default(false)
  backupCodes   BackupCode[]
}

model BackupCode {
  id        String   @id @default(cuid())
  code      String
  used      Boolean  @default(false)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}
```

### 2. Setup 2FA

```typescript
// lib/2fa.ts
import { authenticator } from "otplib";
import { prisma } from "@/lib/prisma";
import { generateBackupCodes } from "@/lib/backup-codes";

export async function setup2FA(userId: string) {
  // Generate secret
  const secret = authenticator.generateSecret();
  
  // Generate backup codes
  const backupCodes = await generateBackupCodes(userId);
  
  // Save secret to user
  await prisma.user.update({
    where: { id: userId },
    data: { twoFactorSecret: secret },
  });
  
  // Generate QR code
  const otpauth = authenticator.keyuri(
    user.email,
    "Your App Name",
    secret
  );
  
  return {
    secret,
    otpauth,
    backupCodes,
  };
}
```

### 3. Verify 2FA

```typescript
// lib/2fa.ts
export async function verify2FA(userId: string, token: string) {
  const user = await prisma.user.findUnique({
    where: { id: userId },
  });
  
  if (!user?.twoFactorSecret) {
    throw new Error("2FA not set up");
  }
  
  const isValid = authenticator.verify({
    token,
    secret: user.twoFactorSecret,
  });
  
  if (!isValid) {
    throw new Error("Invalid 2FA code");
  }
  
  return true;
}
```

### 4. Enable 2FA

```typescript
// app/api/auth/2fa/enable/route.ts
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { setup2FA } from "@/lib/2fa";

export async function POST() {
  const session = await getServerSession();
  
  if (!session?.user?.id) {
    return NextResponse.json(
      { error: "Unauthorized" },
      { status: 401 }
    );
  }
  
  try {
    const { secret, otpauth, backupCodes } = await setup2FA(session.user.id);
    
    return NextResponse.json({
      secret,
      otpauth,
      backupCodes,
    });
  } catch (error) {
    return NextResponse.json(
      { error: "Failed to setup 2FA" },
      { status: 500 }
    );
  }
}
```

## UI Components

### 1. 2FA Setup Form

```typescript
// components/auth/2fa-setup-form.tsx
import { useState } from "react";
import QRCode from "qrcode.react";

export function TwoFactorSetupForm() {
  const [step, setStep] = useState(1);
  const [secret, setSecret] = useState("");
  const [otpauth, setOtpauth] = useState("");
  const [backupCodes, setBackupCodes] = useState<string[]>([]);
  const [verificationCode, setVerificationCode] = useState("");
  
  const handleSetup = async () => {
    try {
      const response = await fetch("/api/auth/2fa/enable", {
        method: "POST",
      });
      
      const data = await response.json();
      
      setSecret(data.secret);
      setOtpauth(data.otpauth);
      setBackupCodes(data.backupCodes);
      setStep(2);
    } catch (error) {
      console.error("Failed to setup 2FA:", error);
    }
  };
  
  const handleVerify = async () => {
    try {
      const response = await fetch("/api/auth/2fa/verify", {
        method: "POST",
        body: JSON.stringify({ code: verificationCode }),
      });
      
      if (response.ok) {
        setStep(3);
      }
    } catch (error) {
      console.error("Failed to verify 2FA:", error);
    }
  };
  
  return (
    <div>
      {step === 1 && (
        <button onClick={handleSetup}>
          Setup 2FA
        </button>
      )}
      
      {step === 2 && (
        <div>
          <h2>Scan QR Code</h2>
          <QRCode value={otpauth} />
          <p>Or enter this code manually: {secret}</p>
          
          <input
            type="text"
            value={verificationCode}
            onChange={(e) => setVerificationCode(e.target.value)}
            placeholder="Enter 6-digit code"
          />
          <button onClick={handleVerify}>
            Verify
          </button>
        </div>
      )}
      
      {step === 3 && (
        <div>
          <h2>Backup Codes</h2>
          <p>Save these backup codes in a secure place:</p>
          <ul>
            {backupCodes.map((code) => (
              <li key={code}>{code}</li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
}
```

### 2. 2FA Verification Form

```typescript
// components/auth/2fa-verify-form.tsx
import { useState } from "react";
import { useRouter } from "next/navigation";

export function TwoFactorVerifyForm() {
  const [code, setCode] = useState("");
  const [error, setError] = useState("");
  const router = useRouter();
  
  const handleVerify = async (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      const response = await fetch("/api/auth/2fa/verify", {
        method: "POST",
        body: JSON.stringify({ code }),
      });
      
      if (response.ok) {
        router.push("/dashboard");
      } else {
        setError("Invalid code");
      }
    } catch (error) {
      setError("An error occurred");
    }
  };
  
  return (
    <form onSubmit={handleVerify}>
      {error && <div className="error">{error}</div>}
      <input
        type="text"
        value={code}
        onChange={(e) => setCode(e.target.value)}
        placeholder="Enter 6-digit code"
        required
      />
      <button type="submit">Verify</button>
    </form>
  );
}
```

## Backup Codes

### 1. Generate Backup Codes

```typescript
// lib/backup-codes.ts
import { randomBytes } from "crypto";

export async function generateBackupCodes(userId: string) {
  const codes = Array.from({ length: 10 }, () => {
    return randomBytes(4).toString("hex").toUpperCase();
  });
  
  await prisma.backupCode.createMany({
    data: codes.map((code) => ({
      code,
      userId,
    })),
  });
  
  return codes;
}
```

### 2. Verify Backup Code

```typescript
// lib/backup-codes.ts
export async function verifyBackupCode(userId: string, code: string) {
  const backupCode = await prisma.backupCode.findFirst({
    where: {
      userId,
      code,
      used: false,
    },
  });
  
  if (!backupCode) {
    throw new Error("Invalid backup code");
  }
  
  await prisma.backupCode.update({
    where: { id: backupCode.id },
    data: { used: true },
  });
  
  return true;
}
```

## Security Considerations

1. **Secret Storage**
   - Encrypt 2FA secrets
   - Use secure database
   - Implement proper access control

2. **Backup Codes**
   - Generate secure codes
   - One-time use only
   - Secure storage

3. **Rate Limiting**
   - Limit verification attempts
   - Implement cooldown periods
   - Monitor for abuse

## Best Practices

1. **User Experience**
   - Clear instructions
   - Helpful error messages
   - Easy recovery process

2. **Security**
   - Strong validation
   - Secure storage
   - Regular audits

3. **Maintenance**
   - Regular code updates
   - Security patches
   - User support

## Next Steps

1. Implement recovery process
2. Add additional 2FA methods
3. Enhance security features
4. Improve user experience

For more detailed information about specific features, refer to the relevant sections in this documentation. 